
# Connecting to IoT Cloud:

**Official google cloud documentation. Provides more detailed information on setting up your IoT device:**

https://cloud.google.com/iot/docs/how-tos/mqtt-bridge

This is a short guide on how to connect your device to Google's IoT Core through MQTT. Feel free to give feedback on if anything is not clear. Good luck :)

## 0. Setting up Google IoT Cloud

configure pub/sub topics

add device

set up functions for listening to the subscriptions/publishes

## 1. Embedded prerequisites

This section discusses the necessary files needed before setting up your IoT device.

### Google root certificates (CA)

Can be acquired from google's official documentation ([full CA download](https://pki.goog/roots.pem), [minimal CA download](https://pki.goog/gtsltsr/gtsltsr.crt))

### Authentication - public/private key pairs and JWT Tokens

**Google cloud documentation:**

https://cloud.google.com/iot/docs/how-tos/credentials/keys

A public/private key pair needs to be generated by the user to allow authenticate the device in IoT Cloud. The public key is used directly on IoT Core as will be shown below. The private key is used further to sign a JSON Web Token (JWT) as proof of the device's identity.

This repository contains a python script for creating the key pairs ([link here]()). COME BACK HERE AND FIX!!

List of possible arguments:

* -h or --help: Provides information about the usable arguments.
* -d or --device: Name of the device, output files use this name.
* -e or --ecdsa: Generates an elliptic curve key
* -r or --rsa: Generates an RSA key

Example usage. This produces an elliptic curve key pair with DEVICE_NAME as the chosen IoT device.

```
python create_keys.py -d DEVICE_NAME -e
```

The output produces a public and private certificate. The public certificate needs to be added into IoT Cloud here:

INSERT IMAGE

The private key needs to be added in the IoT device itself. This is used in creating the JWT needed for authentication upon connecting to IoT Cloud.
Notice that a .c file has also been created. This file can be used instead of the private certificate for easier integration when developing embedded systems in C.

## 2. Connecting your IoT device through MQTT

This part assumes the user to have some familiarity with MQTT. As such, this section will mostly show the necessary parameters for establishing a connection with IoT Core.

### Filling out MQTT parameters

#### Creating JWTs

**Google cloud documentation:**

https://cloud.google.com/iot/docs/how-tos/credentials/jwts

The MQTT connection requires the client to authenticate with a username and password. The username field does not need to be filled out, as IoT Core does not utilize it. The password field is mandatory, in which a client-generated JWT token needs to be written.

```
username = {blank} // non-mandatory, unused by IoT Core
password = {JWT} // mandatory
```

For more info on JWTs, it is suggested to check out the documentation above.